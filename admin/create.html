<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Создать сертификат | Tefiti SPA</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body class="page">
<main class="container">
  <h1>Админ — Создание сертификата</h1>

  <!-- Авторизация -->
  <div id="auth-area">
    <div id="login-area">
      <p>Введите пароль администратора</p>
      <input id="adminPassword" type="password" placeholder="Пароль" />
      <button id="loginBtn">Войти</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <div id="user-info" style="display:none;">
      <p>Вы вошли как админ</p>
      <button id="signout">Выйти</button>
    </div>
  </div>



  <!-- Форма создания сертификата -->
  <form id="createForm" style="display:none;">
    <label>ФИО:
      <input id="full_name" required />
    </label>

    <label>Программа / Стоимость:
      <input id="program" placeholder="Например: SPA-релакс — 60$" />
    </label>

    <label>Дата (дата использования):
      <input id="date" type="date" />
    </label>

    <button type="submit">Создать сертификат</button>
  </form>

  <div id="result" style="display:none;">
    <p>Сертификат создан!</p>
    <p>Код: <b id="codeOut"></b></p>
    <p>Ссылка: <input id="shareLink" readonly style="width:100%"/></p>
    <button id="copyLink">Скопировать ссылку</button>
    <a id="openLink" target="_blank">Открыть ссылку</a>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bcryptjs/dist/bcrypt.min.js"></script>
<script type="module">
  // Теперь bcrypt доступен глобально
  const isValid = bcrypt.compareSync('пароль', '$2a$10$...')
</script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/config.js'


const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

const loginBtn = document.getElementById('loginBtn')
const passwordInput = document.getElementById('adminPassword')
const loginMsg = document.getElementById('loginMsg')
const userInfo = document.getElementById('user-info')
const loginArea = document.getElementById('login-area')
const createForm = document.getElementById('createForm')
const signoutBtn = document.getElementById('signout')
const fullNameInput = document.getElementById('full_name')
const programInput = document.getElementById('program')
const dateInput = document.getElementById('date')
const resultBox = document.getElementById('result')
const codeOut = document.getElementById('codeOut')
const shareLink = document.getElementById('shareLink')
const copyLinkBtn = document.getElementById('copyLink')
const openLinkA = document.getElementById('openLink')

// Функция генерации случайного кода
function randomCode(len=10){
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'
  let s = ''
  for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)]
  return s
}

async function uniqueCode(){
  for(let i=0;i<8;i++){
    const c = randomCode(10)
    const { data } = await supabase.from('certificates').select('id').eq('code', c).limit(1)
    if(!data || data.length===0) return c
  }
  return randomCode(12)
}

loginBtn.onclick = async () => {
  const pw = passwordInput.value.trim()
  if (!pw) {
    loginMsg.textContent = 'Введите пароль'
    return
  }

  try {
    const { data, error } = await supabase
      .from('admins')
      .select('password_hash')
      .limit(1)
      .single()

    if (error) {
      console.error('Ошибка запроса:', error)
      loginMsg.textContent = 'Ошибка проверки пароля'
      return
    }

    if (!data || !data.password_hash) {
      loginMsg.textContent = 'Пароль не найден'
      return
    }

    const isValid = bcrypt.compareSync(pw, data.password_hash)

    if (isValid) {
      loginArea.style.display = 'none'
      userInfo.style.display = 'block'
      createForm.style.display = 'block'
      loginMsg.textContent = ''
    } else {
      loginMsg.textContent = 'Неверный пароль'
    }

  } catch (err) {
    console.error('Ошибка выполнения:', err)
    loginMsg.textContent = 'Произошла ошибка, попробуйте ещё раз'
  }
}



// Выход
signoutBtn.onclick = () => {
  passwordInput.value = ''
  loginMsg.textContent = ''
  createForm.style.display = 'none'
  userInfo.style.display = 'none'
  loginArea.style.display = 'block'
}

// Создание сертификата
createForm.onsubmit = async (e) => {
  e.preventDefault()
  const full_name = fullNameInput.value.trim()
  const program = programInput.value.trim()
  const date = dateInput.value || null
  if(!full_name){ alert('Введите ФИО'); return }

  const code = await uniqueCode()
  const { data, error } = await supabase.from('certificates').insert([{
    code,
    full_name,
    program,
    date
  }]).select().single()

  if(error){ alert('Ошибка при сохранении: '+error.message); console.error(error); return }

  codeOut.textContent = data.code
  const link = `${location.origin}/certificate/view.html?id=${data.id}`
  shareLink.value = link
  openLinkA.href = link
  openLinkA.textContent = 'Открыть сертификат'
  resultBox.style.display = 'block'
}

// Копирование ссылки
copyLinkBtn.onclick = () => {
  shareLink.select()
  document.execCommand('copy')
  copyLinkBtn.textContent = 'Скопировано!'
  setTimeout(()=>copyLinkBtn.textContent='Скопировать ссылку',1500)
}
</script>

</body>
</html>
