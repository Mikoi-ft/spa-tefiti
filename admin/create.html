<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Создание и проверка сертификатов | Tefiti SPA</title>

<link rel="stylesheet" href="/styles.css">
</head>

<body class="page admin-page">
<main class="container">

  <h1>Админ — Создание и проверка сертификатов</h1>

  <!-- Авторизация -->
  <div id="auth-area">

    <div id="login-area">
      <p>Введите пароль администратора</p>
      <input id="adminPassword" type="password" placeholder="Пароль" />
      <button id="loginBtn">Войти</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <div id="user-info" style="display:none;">
      <p>Вы вошли как админ</p>
      <button id="signout">Выйти</button>
    </div>

  </div>

  <!-- Форма создания сертификата -->
  <form id="createForm" style="display:none; margin-top:20px;">
    <h2>Создание сертификата</h2>

    <label>ФИО:
      <input id="full_name" required />
    </label>

    <label>Программа / Стоимость:
      <input id="program" placeholder="Например: SPA-релакс — 60$" />
    </label>

    <label>Дата действия сертификата:
      <input id="date" type="date" />
    </label>

    <button type="submit">Создать сертификат</button>
  </form>

  <!-- Результат создания -->
  <div id="result" style="display:none; margin-top:20px;">
    <p>Сертификат создан!</p>
    <p>Код: <b id="codeOut"></b></p>

    <p>Ссылка:
      <input id="shareLink" readonly style="width:100%" />
    </p>

    <button id="copyLink">Скопировать ссылку</button>
    <a id="openLink" target="_blank" style="margin-left:10px;">Открыть сертификат</a>
  </div>

  <!-- Проверка сертификата -->
  <div id="check-area" style="display:none;">
    <h2>Проверка сертификата по коду</h2>

    <input id="checkCode" maxlength="5" placeholder="Введите 5-значный код" />
    <button id="checkBtn">Проверить</button>

    <div id="checkResult" style="margin-top:10px;"></div>
  </div>

</main>


<!-- ------------------------- JS ---------------------------- -->

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.86.2";
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/config.js'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// элементы
const loginBtn = document.getElementById('loginBtn')
const passwordInput = document.getElementById('adminPassword')
const loginMsg = document.getElementById('loginMsg')
const userInfo = document.getElementById('user-info')
const loginArea = document.getElementById('login-area')
const createForm = document.getElementById('createForm')
const signoutBtn = document.getElementById('signout')
const fullNameInput = document.getElementById('full_name')
const programInput = document.getElementById('program')
const dateInput = document.getElementById('date')
const resultBox = document.getElementById('result')
const codeOut = document.getElementById('codeOut')
const shareLink = document.getElementById('shareLink')
const copyLinkBtn = document.getElementById('copyLink')
const openLinkA = document.getElementById('openLink')

const checkArea = document.getElementById('check-area')
const checkBtn = document.getElementById('checkBtn')
const checkCodeInput = document.getElementById('checkCode')
const checkResult = document.getElementById('checkResult')

// пароль
const ADMIN_PASSWORD = "tefiti000"


/* ---------------- Авторизация ---------------- */
loginBtn.onclick = () => {
  const pw = passwordInput.value.trim()

  if (!pw) {
    loginMsg.textContent = "Введите пароль"
    return
  }

  if (pw === ADMIN_PASSWORD) {
    loginArea.style.display = "none"
    userInfo.style.display = "block"
    createForm.style.display = "block"
    checkArea.style.display = "block"
    loginMsg.textContent = ""
  } else {
    loginMsg.textContent = "Неверный пароль"
  }
}

signoutBtn.onclick = () => {
  passwordInput.value = ""
  loginMsg.textContent = ""
  createForm.style.display = "none"
  userInfo.style.display = "none"
  loginArea.style.display = "block"
  checkArea.style.display = "none"
}


/* ------------ Создание сертификата ----------------- */
createForm.onsubmit = async (e) => {
  e.preventDefault()

  const full_name = fullNameInput.value.trim()
  const program = programInput.value.trim()
  const date = dateInput.value || null

  if (!full_name) {
    alert("Введите ФИО")
    return
  }

  const { data, error } = await supabase.rpc('insert_certificate_with_password', {
    p_password: ADMIN_PASSWORD,
    p_full_name: full_name,
    p_program: program,
    p_date: date
  })

  if (error) {
    alert("Ошибка: " + error.message)
    return
  }

  const id = data[0].cert_id
  const code = data[0].cert_code

  codeOut.textContent = code

  const link = `${location.origin}/certificate/view.html?id=${id}`
  shareLink.value = link
  openLinkA.href = link

  resultBox.style.display = "block"
}

// копирование ссылки после создания
copyLinkBtn.onclick = () => {
  const text = `Ваш подарочный сертификат доступен по ссылке: ${shareLink.value}`;

  navigator.clipboard.writeText(text)
    .then(() => alert("Ссылка скопирована!"))
    .catch(() => alert("Ошибка копирования"));
}



/* ------------ Проверка сертификата ----------------- */

checkBtn.onclick = async () => {
  const code = checkCodeInput.value.trim()

  if (!/^\d{5}$/.test(code)) {
    alert("Введите корректный 5-значный код")
    return
  }

  const { data, error } = await supabase
    .from("certificates")
    .select("*")
    .eq("code", code)
    .single()

  if (error || !data) {
    checkResult.innerHTML = `<p style="color:red">❌ Сертификат не найден</p>`
    return
  }

  const link = `${location.origin}/certificate/view.html?id=${data.id}`

  checkResult.innerHTML = `
    <p style="color:green">✔ Сертификат найден</p>

    <p><b>ФИО:</b> ${data.full_name}</p>
    <p><b>Программа:</b> ${data.program || '-'}</p>
    <p><b>Дата действия:</b> ${data.date || '-'}</p>
    <p><b>Создан:</b> ${new Date(data.created_at).toLocaleString()}</p>

    <p><b>Статус:</b>
      ${data.used 
        ? "<span style='color:red'>Использован</span>" 
        : "<span style='color:green'>Не использован</span>"
      }
    </p>

    ${data.used_at 
      ? `<p><b>Дата использования:</b> ${new Date(data.used_at).toLocaleString()}</p>` 
      : ""
    }

    ${
      data.used 
        ? "" 
        : `<button id="markUsedBtn" style="margin-top:10px;">Отметить как использованный</button>`
    }

    <p style="margin-top:20px;">
      Ссылка на сертификат:<br>
      <input id="checkShareLink" value="${link}" readonly style="width:100%; margin-top:6px;" />
      <button id="checkCopyLinkBtn" style="margin-top:10px;">Скопировать ссылку</button>
    </p>
  `

  /* ----------------------------
     КНОПКА КОПИРОВАНИЯ ССЫЛКИ
  ----------------------------- */
  const copyBtn = document.getElementById("checkCopyLinkBtn")
  if (copyBtn) {
    copyBtn.onclick = () => {
      const text = `Ваш подарочный сертификат доступен по ссылке ${link}`
      navigator.clipboard.writeText(text)
        .then(() => alert("Ссылка скопирована!"))
    }
  }

  /* -----------------------------------------
     КНОПКА "ОТМЕТИТЬ КАК ИСПОЛЬЗОВАННЫЙ"
  ------------------------------------------ */
  const markUsedBtn = document.getElementById("markUsedBtn")

  if (markUsedBtn) {
    markUsedBtn.onclick = async () => {
      if (!confirm("Отметить сертификат как использованный?")) return;

      const { error: updateError } = await supabase
        .from("certificates")
        .update({
          used: true,
          used_at: new Date().toISOString()
        })
        .eq("id", data.id)

      if (updateError) {
        alert("Ошибка при обновлении: " + updateError.message)
        return
      }

      alert("Сертификат отмечен как использованный!")
      checkBtn.click()   // перезагрузить данные проверки
    }
  }
}
</script>

</body>
</html>
