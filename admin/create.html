<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Создание и проверка сертификатов | Tefiti SPA</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body class="page">
<main class="container">
  <h1>Админ — Создание и проверка сертификатов</h1>

  <!-- Авторизация -->
  <div id="auth-area">
    <div id="login-area">
      <p>Введите пароль администратора</p>
      <input id="adminPassword" type="password" placeholder="Пароль" />
      <button id="loginBtn">Войти</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <div id="user-info" style="display:none;">
      <p>Вы вошли как админ</p>
      <button id="signout">Выйти</button>
    </div>
  </div>

  <!-- Форма создания сертификата -->
  <form id="createForm" style="display:none; margin-top:20px;">
    <h2>Создание сертификата</h2>
    <label>ФИО:
      <input id="full_name" required />
    </label>
    <label>Программа / Стоимость:
      <input id="program" placeholder="Например: SPA-релакс — 60$" />
    </label>
    <label>Дата действия сертификата:
      <input id="date" type="date" />
    </label>
    <button type="submit">Создать сертификат</button>
  </form>

  <div id="result" style="display:none; margin-top:20px;">
    <p>Сертификат создан!</p>
    <p>Код: <b id="codeOut"></b></p>
    <p>Ссылка:
      <input id="shareLink" readonly style="width:100%"/>
    </p>
    <button id="copyLink">Скопировать ссылку</button>
    <a id="openLink" target="_blank" style="margin-left:10px;">Открыть сертификат</a>
  </div>

  <!-- Проверка сертификата -->
  <div id="check-area" style="display:none;">
    <h2>Проверка сертификата по коду</h2>
    <input id="checkCode" maxlength="5" placeholder="Введите 5-значный код" />
    <button id="checkBtn">Проверить</button>
    <div id="checkResult" style="margin-top:10px;"></div>
  </div>

</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/config.js'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Элементы
const loginBtn = document.getElementById('loginBtn')
const passwordInput = document.getElementById('adminPassword')
const loginMsg = document.getElementById('loginMsg')
const userInfo = document.getElementById('user-info')
const loginArea = document.getElementById('login-area')
const createForm = document.getElementById('createForm')
const signoutBtn = document.getElementById('signout')
const fullNameInput = document.getElementById('full_name')
const programInput = document.getElementById('program')
const dateInput = document.getElementById('date')
const resultBox = document.getElementById('result')
const codeOut = document.getElementById('codeOut')
const shareLink = document.getElementById('shareLink')
const copyLinkBtn = document.getElementById('copyLink')
const openLinkA = document.getElementById('openLink')

// Проверка сертификата
const checkArea = document.getElementById('check-area')
const checkBtn = document.getElementById('checkBtn')
const checkCodeInput = document.getElementById('checkCode')
const checkResult = document.getElementById('checkResult')

// ---------- Локальная авторизация ----------
const ADMIN_PASSWORD = "tefiti000"

loginBtn.onclick = () => {
  const pw = passwordInput.value.trim()
  if (!pw) { loginMsg.textContent = 'Введите пароль'; return }
  if (pw === ADMIN_PASSWORD){
    loginArea.style.display = 'none'
    userInfo.style.display = 'block'
    createForm.style.display = 'block'
    checkArea.style.display = 'block'
    loginMsg.textContent = ''
  } else {
    loginMsg.textContent = 'Неверный пароль'
  }
}

signoutBtn.onclick = () => {
  passwordInput.value = ''
  loginMsg.textContent = ''
  createForm.style.display = 'none'
  userInfo.style.display = 'none'
  loginArea.style.display = 'block'
  checkArea.style.display = 'none'
}

// ---------- Создание сертификата через RPC ----------
createForm.onsubmit = async (e) => {
  e.preventDefault()
  const full_name = fullNameInput.value.trim()
  const program = programInput.value.trim()
  const date = dateInput.value || null
  if (!full_name) { alert('Введите ФИО'); return }

  const { data, error } = await supabase.rpc('insert_certificate_with_password', {
    p_password: ADMIN_PASSWORD,
    p_full_name: full_name,
    p_program: program,
    p_date: date
  })

  if (error) { alert('Ошибка при сохранении: ' + error.message); return }

  const id = data[0].cert_id
  const code = data[0].cert_code

  codeOut.textContent = code

  const link = `${location.origin}/certificate/view.html?id=${id}`
  shareLink.value = link
  openLinkA.href = link
  openLinkA.textContent = 'Открыть сертификат'

  resultBox.style.display = 'block'
}

// ---------- Проверка сертификата по коду ----------
checkBtn.onclick = async () => {
  const code = checkCodeInput.value.trim()
  if (!/^\d{5}$/.test(code)){ alert("Введите корректный 5-значный код"); return }

  const { data, error } = await supabase
    .from('certificates')
    .select('*')
    .eq('code', code)
    .single()

  if (error || !data){
    checkResult.innerHTML = `<p style="color:red">❌ Сертификат не найден</p>`
    return
  }

  const link = `${location.origin}/certificate/view.html?id=${data.id}`

  checkResult.innerHTML = `
    <p style="color:green">✔ Сертификат найден</p>
    <p><b>ФИО:</b> ${data.full_name}</p>
    <p><b>Программа:</b> ${data.program || '-'}</p>
    <p><b>Дата:</b> ${data.date || '-'}</p>
    <p><b>Создан:</b> ${new Date(data.created_at).toLocaleString()}</p>
    <p>Ссылка на сертификат:
      <input id="checkShareLink" value="${link}" readonly style="width:100%"/>
      <button id="checkCopyLinkBtn">Скопировать ссылку</button>
    </p>
  `

  // копирование ссылки
  document.getElementById('checkCopyLinkBtn').onclick = () => {
    const textToCopy = `Ваш подарочный сертификат на SPA Tefiti доступен по ссылке ${link}`
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        alert('Ссылка скопирована!')
      })
      .catch(err => alert('Не удалось скопировать: ' + err))
  }
}
</script>
</body>
</html>
