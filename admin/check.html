<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Проверка сертификата</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="container">
    <h1>Проверка подлинности (админ)</h1>

    <div id="auth-area">
      <div id="user-info" style="display:none;">
        <p>Вы вошли как <span id="user-email"></span></p>
        <button id="signout">Выйти</button>
      </div>

      <div id="login-area">
        <p>Войдите через email (админ)</p>
        <input id="email" placeholder="Email" />
        <button id="sendLink">Отправить ссылку для входа</button>
        <p id="loginMsg"></p>
      </div>
    </div>

    <hr />

    <div id="checker" style="display:none">
      <input id="codeInput" placeholder="Введите уникальный код (например ABC123...)" style="width:60%"/>
      <button id="checkBtn">Проверить</button>
      <div id="checkResult"></div>
    </div>
  </main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/config.js'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

const emailInput = document.getElementById('email')
const sendLinkBtn = document.getElementById('sendLink')
const loginMsg = document.getElementById('loginMsg')
const userInfo = document.getElementById('user-info')
const userEmailEl = document.getElementById('user-email')
const signoutBtn = document.getElementById('signout')
const checker = document.getElementById('checker')

sendLinkBtn.onclick = async () => {
  const email = emailInput.value.trim()
  if(!email){ loginMsg.textContent = 'Введите email'; return }
  const { error } = await supabase.auth.signInWithOtp({ email })
  if (error) loginMsg.textContent = 'Ошибка: ' + error.message
  else loginMsg.textContent = 'Ссылка для входа отправлена на email.'
}

signoutBtn.onclick = async () => {
  await supabase.auth.signOut()
  location.reload()
}

supabase.auth.onAuthStateChange(async (event, session) => {
  const user = session?.user
  if (user) {
    userInfo.style.display = 'block'
    document.getElementById('login-area').style.display = 'none'
    userEmailEl.textContent = user.email
    checker.style.display = 'block'
  } else {
    userInfo.style.display = 'none'
    document.getElementById('login-area').style.display = 'block'
    checker.style.display = 'none'
  }
})

document.getElementById('checkBtn').onclick = async () => {
  const code = document.getElementById('codeInput').value.trim()
  if(!code){ alert('Введите код'); return }
  const { data, error } = await supabase.from('certificates').select('*').eq('code', code).limit(1).single()
  const resDiv = document.getElementById('checkResult')
  if(error || !data){ resDiv.innerHTML = '<p style="color:red">Сертификат не найден или код неверный</p>'; return }
  resDiv.innerHTML = `<p style="color:green">Действительный сертификат</p>
    <p>ФИО: ${data.full_name}</p>
    <p>Программа: ${data.program || '-'}</p>
    <p>Дата: ${data.date ? new Date(data.date).toLocaleDateString() : '-'}</p>
    <p>Создан: ${new Date(data.created_at).toLocaleString()}</p>
  `
}
</script>
</body>
</html>
