<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Проверка сертификата</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>
<main class="container">
  <h1>Проверка подлинности (админ)</h1>

  <!-- Авторизация -->
  <div id="auth-area">
    <div id="login-area">
      <p>Введите пароль администратора</p>
      <input id="adminPassword" type="password" placeholder="Пароль" />
      <button id="loginBtn">Войти</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <div id="user-info" style="display:none;">
      <p>Вы вошли как админ</p>
      <button id="signout">Выйти</button>
    </div>
  </div>

  <hr />

  <!-- Блок проверки сертификата -->
  <div id="checker" style="display:none">
    <input id="codeInput" placeholder="Введите код (5 цифр)" style="width:60%" maxlength="5"/>
    <button id="checkBtn">Проверить</button>
    <div id="checkResult"></div>
  </div>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/config.js'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// ЭЛЕМЕНТЫ
const loginBtn = document.getElementById('loginBtn')
const passwordInput = document.getElementById('adminPassword')
const loginMsg = document.getElementById('loginMsg')
const userInfo = document.getElementById('user-info')
const loginArea = document.getElementById('login-area')
const signoutBtn = document.getElementById('signout')
const checker = document.getElementById('checker')

// ❗ Пароль администратора (хранится в коде)
const ADMIN_PASSWORD = "tefiti000"

// ---------- Авторизация ----------
loginBtn.onclick = () => {
  const pw = passwordInput.value.trim()

  if (!pw) {
    loginMsg.textContent = 'Введите пароль'
    return
  }

  if (pw === ADMIN_PASSWORD) {
    loginArea.style.display = 'none'
    userInfo.style.display = 'block'
    checker.style.display = 'block'
    loginMsg.textContent = ''
  } else {
    loginMsg.textContent = 'Неверный пароль'
  }
}

// ---------- Выход ----------
signoutBtn.onclick = () => {
  passwordInput.value = ''
  loginMsg.textContent = ''
  userInfo.style.display = 'none'
  checker.style.display = 'none'
  loginArea.style.display = 'block'
}

// ---------- Проверка сертификата ----------
document.getElementById('checkBtn').onclick = async () => {
  const code = document.getElementById('codeInput').value.trim()
  const resDiv = document.getElementById('checkResult')

  // Проверка формата: ровно 5 цифр
  if (!/^\d{5}$/.test(code)) {
    resDiv.innerHTML = '<p style="color:red">Код должен состоять из 5 цифр</p>'
    return
  }

  const { data, error } = await supabase
    .from('certificates')
    .select('*')
    .eq('code', code)
    .limit(1)
    .single()

  if (error || !data) {
    resDiv.innerHTML = '<p style="color:red">Сертификат не найден</p>'
    return
  }

  resDiv.innerHTML = `
    <p style="color:green">Действительный сертификат</p>
    <p><b>ФИО:</b> ${data.full_name}</p>
    <p><b>Программа:</b> ${data.program || '-'}</p>
    <p><b>Дата:</b> ${data.date ? new Date(data.date).toLocaleDateString() : '-'}</p>
    <p><b>Создан:</b> ${new Date(data.created_at).toLocaleString()}</p>
  `
}
</script>
</body>
</html>
