<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Подарочный сертификат | Tefiti SPA</title>

<link rel="stylesheet" href="/styles.css">

<style>
@font-face {
  font-family: 'Becker';
  src: url('/Becker.ttf') format('truetype');
  font-display: swap;
}
/* Важно: убираем дефолтные отступы, чтобы центровка была точной */
body { font-family: 'Becker', sans-serif; font-size: 28px; margin: 0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

/* ВНЕШНЯЯ кнопка */
#downloadPdfExternal {
  display: none;
  margin: 30px auto 0 auto;
  padding: 14px 24px;
  background: #E39E3A;
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  border: none;
  font-size: 22px;
  transition: 0.25s;
}
#downloadPdfExternal:hover { transform: scale(1.05); }

/* МЕЛКИЙ ТЕКСТ */
.small-notes {
  font-size: 10px;
  margin-top: 20px;
  line-height: 1.4;
  opacity: 0.85;
  text-align: left;
}

/* Контейнер и карточка — ключевые правки:
   - добавил вертикальные паддинги у контейнера, чтобы на очень больших экранах
     карточка не висела слишком далеко от центра
   - ограничил max-height карточки (чтобы визуально она была меньше сверху/снизу)
*/
.container.center {
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding: 36px 20px; /* уменьшает видимые пустоты сверху/снизу на широких экранах */
  box-sizing: border-box;
}

/* Фиксированная ширина и высота карточки, но с ограничением по высоте окна */
.card {
  width: 900px;
  height: 600px;
  max-height: calc(100vh - 72px); /* не будет занимать всё окно — оставит ~36px сверху/снизу */
  border-radius:18px;
  box-shadow:0 30px 80px rgba(0,0,0,0.25);
  overflow:hidden;
  background:white;
  position:relative;
  transition: transform 0.35s ease;
  box-sizing: border-box;
}

/* если на очень узких экранах уменьшаем карточку */
@media (max-height: 700px) {
  .card { height: 520px; max-height: calc(100vh - 48px); }
}
@media (max-width: 960px) {
  .card { width: calc(100% - 48px); height: auto; padding: 24px; }
}

/* Класс лицевой части и внутри */
.card-front { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; cursor:pointer; padding: 40px; box-sizing: border-box; }
.certificate { padding:40px; box-sizing: border-box; }
.cert-row { margin:14px 0; display:flex; gap:16px; align-items:center; }
.label { font-weight:700; width:240px; display:inline-block; }
.value { font-weight:500; }
.logo { width:140px; margin-bottom:20px; }

/* Небольшая мелочь: гарантируем, что внутренние элементы не меняют высоту карточки */
.card-inner, .card-front { min-height: 1px; }

/* Hint (опционально) */
#sound-hint {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 18px;
  background: rgba(0,0,0,0.45);
  color: #fff;
  padding: 8px 14px;
  border-radius: 999px;
  font-size: 13px;
  backdrop-filter: blur(4px);
  z-index: 20000;
  pointer-events: auto;
  transition: opacity 220ms ease, transform 220ms ease;
}
#sound-hint.hidden { opacity: 0; pointer-events: none; transform: translateX(-50%) translateY(6px); }
</style>
</head>

<body class="page certificate-page">

<canvas id="confetti-canvas"
  style="position:fixed;left:0;top:0;pointer-events:none;z-index:9999;">
</canvas>

<main class="container center">

  <div id="card-wrap">
    <div class="card closed">

      <!-- Лицевая -->
      <div class="card-front">
        <img src="/logo.svg" alt="Tefiti SPA" class="logo">
        <h2 class="front-title">Подарочный сертификат</h2>
      </div>

      <!-- Внутри -->
      <div class="card-inner" style="display:none;">
        <div class="certificate">

          <h2 class="cert-title">Подарочный сертификат</h2>

          <div class="cert-row">
            <span class="label">Кому:</span>
            <span class="value" id="full_name"></span>
          </div>

          <div class="cert-row">
            <span class="label">На услугу / программу:</span>
            <span class="value" id="program"></span>
          </div>

          <div class="cert-row">
            <span class="label">Действителен до:</span>
            <span class="value" id="date"></span>
          </div>

          <div class="cert-row">
            <span class="label">Уникальный номер:</span>
            <span class="value" id="code"></span>
          </div>

          <div class="small-notes">
            *Сертификат действует по предварительной записи +996755181514<br>
            *Сертификат не подлежит возврату и обмену на денежное средство<br>
            *Если стоимость процедуры меньше стоимости услуги остаток можно использовать в счет следующей процедуры.
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Кнопка PDF -->
  <button id="downloadPdfExternal">Скачать PDF</button>

  <p id="loading">Загрузка сертификата...</p>
</main>

<!-- Скрытое аудио — без контролов -->
<audio id="bg-music" src="/music.mp3" loop preload="auto" style="display:none"></audio>


<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.86.2?bundle";
import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/config.js'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

const id = new URLSearchParams(location.search).get('id')

const loading = document.getElementById('loading')
const card = document.querySelector('.card')
const front = document.querySelector('.card-front')
const inner = document.querySelector('.card-inner')

const fullNameEl = document.getElementById('full_name')
const programEl = document.getElementById('program')
const dateEl = document.getElementById('date')
const codeEl = document.getElementById('code')

const externalPdfBtn = document.getElementById('downloadPdfExternal')
const soundHint = document.getElementById('sound-hint')

if (!id) {
  loading.textContent = 'Некорректная ссылка (нет id)'
} else {
  (async () => {
    const { data, error } = await supabase
      .from('certificates')
      .select('*')
      .eq('id', id)
      .single()

    if (error || !data) {
      loading.textContent = 'Сертификат не найден'
      return
    }

    loading.style.display = 'none'

    fullNameEl.textContent = data.full_name
    programEl.textContent = data.program
    dateEl.textContent = data.date ? new Date(data.date).toLocaleDateString() : ''
    codeEl.textContent = data.code

    front.onclick = openCard

    function openCard() {
      card.classList.remove('closed')
      card.classList.add('opened')
      inner.style.display = 'block'
      front.style.display = 'none'
      externalPdfBtn.style.display = 'block'
      startCelebration()
    }

    externalPdfBtn.onclick = async () => {
      const el = document.querySelector('.certificate')
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js')
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')

      const canvas = await html2canvas(el, { scale: 3 })
      const img = canvas.toDataURL('image/png', 1.0)

      const { jsPDF } = window.jspdf
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'px',
        format: [canvas.width, canvas.height]
      })

      pdf.addImage(img, 'PNG', 0, 0, canvas.width, canvas.height)
      pdf.save(`Tefiti-certificate-${codeEl.textContent}.pdf`)
    }
  })()
}

function loadScript(src) {
  return new Promise((res, rej) => {
    const s = document.createElement('script')
    s.src = src
    s.onload = res
    s.onerror = rej
    document.head.appendChild(s)
  })
}

async function startCelebration() {
  await loadScript('https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js')
  const canvas = document.getElementById('confetti-canvas')
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight
  const blast = confetti.create(canvas, { resize: true, useWorker: true })

  blast({ particleCount: 140, spread: 150, origin: { y: 0.6 } })
  setTimeout(() => blast({ particleCount: 90, spread: 120 }), 500)
  setTimeout(() => blast({ particleCount: 70, spread: 160 }), 900)
}

/* =========================
   Фоновая музыка: старт до открытия конверта
   - Попытка play() с звуком; при блокировке — play() в muted + hint
   - После любого клика/тапа/keydown — unmute + fade-in
   ========================= */
(function initBackgroundAudio() {
  const AUDIO_SRC = '/music.mp3' // <-- поменяй путь, если нужно
  const TARGET_VOLUME = 0.25
  const FADE_MS = 1500
  const audio = document.getElementById('bg-music')
  if (!audio) return
  if (!audio.src) audio.src = AUDIO_SRC
  audio.loop = true
  audio.preload = 'auto'
  audio.volume = 0.0
  audio.muted = false

  function fadeTo(target, ms) {
    const steps = 30
    const stepTime = Math.max(10, ms / steps)
    const delta = (target - audio.volume) / steps
    let i = 0
    const t = setInterval(() => {
      i++
      audio.volume = Math.min(1, Math.max(0, audio.volume + delta))
      if (i >= steps) clearInterval(t)
    }, stepTime)
  }

  function showHint() { if (soundHint) soundHint.classList.remove('hidden') }
  function hideHint() { if (soundHint) soundHint.classList.add('hidden') }

  async function unmuteAndFade() {
    try {
      audio.muted = false
      await audio.play().catch(()=>{})
      fadeTo(TARGET_VOLUME, FADE_MS)
    } catch (e) {
      console.warn('unmute failed', e)
    } finally {
      hideHint()
      removeGestureListeners()
    }
  }

  function onUserGesture() { unmuteAndFade() }
  function addGestureListeners() {
    window.addEventListener('click', onUserGesture, { once: true, passive: true })
    window.addEventListener('touchstart', onUserGesture, { once: true, passive: true })
    window.addEventListener('keydown', onUserGesture, { once: true, passive: true })
  }
  function removeGestureListeners() {
    window.removeEventListener('click', onUserGesture)
    window.removeEventListener('touchstart', onUserGesture)
    window.removeEventListener('keydown', onUserGesture)
  }

  audio.play().then(() => {
    fadeTo(TARGET_VOLUME, FADE_MS)
    hideHint()
  }).catch(async () => {
    try {
      audio.muted = true
      await audio.play()
      showHint()
      addGestureListeners()
    } catch (err2) {
      showHint()
      addGestureListeners()
    }
  })

  window.addEventListener('beforeunload', () => {
    try { audio.pause(); audio.currentTime = 0 } catch (e) {}
  })
})();
</script>

</body>
</html>
